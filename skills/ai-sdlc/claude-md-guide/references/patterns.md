# CLAUDE.md Patterns Reference

Advanced patterns for project instruction files, organized by use case.

## Pattern: Conditional Instructions

Use when behavior should vary by context:

```markdown
## File Types
- `.tsx` files: Use functional components with TypeScript interfaces
- `.test.tsx` files: Use `describe/it` blocks, not `test()`
- `.css` files: Do not edit directly — styles are generated from Tailwind
- `*.generated.ts`: Never edit — these are auto-generated by GraphQL codegen
```

## Pattern: Error Prevention Checklist

List the mistakes the AI makes most often:

```markdown
## Common Mistakes to Avoid
1. Importing from `@/lib/db` in client components (server-only module)
2. Using `fetch()` directly — always use the `api` wrapper from `@/lib/api`
3. Adding `async` to React client components (not supported)
4. Forgetting to add new routes to `middleware.ts` auth matcher
5. Using `console.log` — use the `logger` from `@/lib/logger` instead
```

## Pattern: Decision Records

When the AI needs to understand *why* a decision was made:

```markdown
## Architecture Decisions
- **Why Drizzle over Prisma**: We need raw SQL escape hatches and Prisma's
  query engine adds cold start latency in serverless
- **Why RSC over client-side fetching**: Reduces bundle size and waterfall
  requests; we accept the DX tradeoff
- **Why pnpm over npm**: Workspace support and disk efficiency for our monorepo
```

## Pattern: Review Gates

Instructions that apply when the AI reviews its own work:

```markdown
## Before Submitting Changes
1. Run `npm test` — all tests must pass
2. Run `npm run lint` — zero warnings
3. Run `npm run build` — must complete without errors
4. If you modified a database model, create an Alembic migration
5. If you added a new API endpoint, add it to `docs/api.md`
6. If you added a new env var, add it to `.env.example`
```

## Pattern: Dependency Policy

Control what the AI installs:

```markdown
## Dependencies
- Do NOT add new npm packages without asking first
- Prefer standard library over third-party for: date formatting, UUID generation, path manipulation
- Allowed utility libraries: lodash-es, date-fns, zod
- Forbidden: moment.js, lodash (use lodash-es), axios (use native fetch)
```

## Pattern: Test Strategy

Tell the AI how to test, not just that it should:

```markdown
## Testing
- Unit tests: colocated in `__tests__/` next to source files
- Integration tests: `tests/integration/` — test API routes with real DB
- E2E tests: `tests/e2e/` — Playwright, run with `npx playwright test`
- Mock strategy: msw for HTTP, vi.mock for modules, factory functions for test data
- Coverage target: 80% for new code (don't backfill coverage for untouched files)
- Test naming: `should [expected behavior] when [condition]`
```

## Pattern: Git Conventions

```markdown
## Git
- Branch naming: `feat/`, `fix/`, `chore/` prefixes
- Commit messages: conventional commits (feat:, fix:, docs:, chore:)
- Never force push to main
- Squash merge PRs
- Delete branches after merge
```

## Pattern: Security Boundaries

```markdown
## Security
- Never log PII (email, name, phone, IP addresses)
- All user input must be validated with Zod schemas before processing
- SQL queries must use parameterized queries (no string interpolation)
- API keys go in environment variables, never in code
- Files in `src/auth/` handle authentication — do not modify without explicit request
```

## Pattern: Monorepo Navigation

```markdown
## Monorepo Structure
packages/
  ui/          — React component library (Storybook)
  api-client/  — Generated API client (do not edit manually)
  config/      — Shared ESLint, TypeScript, and Tailwind configs
apps/
  web/         — Next.js frontend (imports from packages/ui)
  api/         — Express backend
  worker/      — Background job processor (BullMQ)

## Cross-Package Rules
- `packages/ui` must not import from `apps/`
- `apps/web` and `apps/api` share types via `packages/api-client`
- Run `pnpm build --filter=packages/*` before testing apps
```

## Pattern: AI Interaction Preferences

```markdown
## How to Work With Me
- Make changes incrementally — one file at a time for complex refactors
- Run tests after each meaningful change, not just at the end
- If you're unsure about a design choice, explain the tradeoffs and ask
- Prefer modifying existing files over creating new ones
- When fixing a bug, write a failing test first, then fix it
```

## Pattern: Legacy Code Boundaries

```markdown
## Legacy vs. Modern Code
- `src/legacy/` — jQuery-based components. Do not refactor unless asked.
  When fixing bugs here, match existing patterns (no React, no ES modules)
- `src/app/` — Modern React code. All new features go here.
- Migration rule: Only migrate legacy components when a feature request
  touches them AND the user explicitly approves the migration
```

## Combining Patterns

A mature CLAUDE.md typically uses 4-6 of these patterns. Start with:
1. Commands (always)
2. Error Prevention (high leverage)
3. Conventions (reduces back-and-forth)
4. Test Strategy (enables self-verification)

Add more patterns as you discover repeated friction in AI interactions.
